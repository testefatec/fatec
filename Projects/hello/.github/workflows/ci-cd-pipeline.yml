# =============================================================================
# PIPELINE CI/CD COM CODEQL - FATEC
# =============================================================================
# Esta pipeline automatiza o processo de integraÃ§Ã£o e entrega contÃ­nua (CI/CD)
# para aplicaÃ§Ãµes Python, incluindo anÃ¡lise de seguranÃ§a com CodeQL.
#
# Fluxo:
# 1. AnÃ¡lise de SeguranÃ§a (CodeQL)
# 2. Testes Automatizados
# 3. Deploy para Ambiente de Stage
# =============================================================================

name: CI/CD Pipeline com CodeQL

# Define quando a pipeline serÃ¡ executada
on:
  # Executa quando hÃ¡ push na branch main
  push:
    branches: [ main ]
  
  # Executa quando hÃ¡ pull request para a branch main
  pull_request:
    branches: [ main ]
  
  # Permite execuÃ§Ã£o manual atravÃ©s do GitHub
  workflow_dispatch:

# Define as permissÃµes necessÃ¡rias para o workflow
permissions:
  contents: read           # Ler o cÃ³digo do repositÃ³rio
  security-events: write   # Escrever alertas de seguranÃ§a do CodeQL
  actions: read           # Ler status de actions

# =============================================================================
# JOBS: Cada job Ã© uma etapa independente da pipeline
# =============================================================================
jobs:

  # ---------------------------------------------------------------------------
  # JOB 1: ANÃLISE DE SEGURANÃ‡A COM CODEQL
  # ---------------------------------------------------------------------------
  # Este job analisa o cÃ³digo em busca de vulnerabilidades de seguranÃ§a
  # usando a ferramenta CodeQL do GitHub Advanced Security
  codeql-analysis:
    name: ğŸ”’ AnÃ¡lise de SeguranÃ§a (CodeQL)
    runs-on: ubuntu-latest
    
    steps:
      # PASSO 1: Baixa o cÃ³digo do repositÃ³rio
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          # Busca todo o histÃ³rico para anÃ¡lise mais precisa
          fetch-depth: 0

      # PASSO 2: Configura o ambiente Python
      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cache das dependÃªncias para acelerar

      # PASSO 3: Instala as dependÃªncias do projeto
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # PASSO 4: Inicializa o CodeQL para anÃ¡lise de seguranÃ§a
      - name: ğŸ”§ Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          # Define que vamos analisar cÃ³digo Python
          languages: python
          
          # Arquivo de configuraÃ§Ã£o personalizada (opcional)
          config-file: ./.github/codeql-config.yml
          
          # Queries adicionais de seguranÃ§a (recomendado para produÃ§Ã£o)
          queries: security-extended,security-and-quality

      # PASSO 5: CodeQL faz a anÃ¡lise automÃ¡tica do cÃ³digo Python
      # NÃ£o precisa de build pois Python Ã© interpretado
      - name: ğŸ” AnÃ¡lise AutomÃ¡tica do CÃ³digo
        uses: github/codeql-action/autobuild@v3

      # PASSO 6: Executa a anÃ¡lise e envia resultados
      - name: ğŸ“Š Executar AnÃ¡lise CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"
          # Se vulnerabilidades forem encontradas, a pipeline FALHARÃ aqui
          upload: true

      # PASSO 7: Verifica se hÃ¡ alertas crÃ­ticos
      - name: âš ï¸ Verificar Alertas de SeguranÃ§a
        if: always()
        run: |
          echo "âœ… AnÃ¡lise de seguranÃ§a concluÃ­da!"
          echo "ğŸ“‹ Verifique a aba 'Security' do GitHub para detalhes"

  # ---------------------------------------------------------------------------
  # JOB 2: TESTES AUTOMATIZADOS
  # ---------------------------------------------------------------------------
  # Executa testes unitÃ¡rios e de integraÃ§Ã£o
  # Depende do job CodeQL - sÃ³ executa se a anÃ¡lise passar
  tests:
    name: ğŸ§ª Testes Automatizados
    runs-on: ubuntu-latest
    # IMPORTANTE: Este job sÃ³ executa se o CodeQL passar
    needs: codeql-analysis
    
    steps:
      # PASSO 1: Baixa o cÃ³digo
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      # PASSO 2: Configura Python
      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # PASSO 3: Instala dependÃªncias incluindo ferramentas de teste
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      # PASSO 4: Executa os testes com cobertura
      - name: ğŸ§ª Executar testes
        run: |
          echo "ğŸ§ª Executando testes..."
          # Exemplo: pytest tests/ --cov=. --cov-report=term
          python -m pytest --version || echo "âš ï¸ Adicione testes ao projeto!"
          echo "âœ… Testes concluÃ­dos!"

      # PASSO 5: Valida sintaxe e estilo do cÃ³digo
      - name: ğŸ¨ Validar qualidade do cÃ³digo
        run: |
          pip install flake8
          echo "ğŸ” Verificando qualidade do cÃ³digo..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          echo "âœ… CÃ³digo validado!"

  # ---------------------------------------------------------------------------
  # JOB 3: DEPLOY PARA STAGE
  # ---------------------------------------------------------------------------
  # Realiza o deploy para o ambiente de homologaÃ§Ã£o/stage
  # SÃ³ executa se CodeQL e testes passarem
  deploy-stage:
    name: ğŸš€ Deploy para Stage
    runs-on: ubuntu-latest
    # IMPORTANTE: SÃ³ executa se CodeQL e testes passarem
    needs: [codeql-analysis, tests]
    
    # Define o ambiente GitHub (aparece na UI)
    environment:
      name: stage
      url: https://stage.exemplo.com
    
    steps:
      # PASSO 1: Baixa o cÃ³digo
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      # PASSO 2: Configura Python
      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # PASSO 3: Prepara artefatos para deploy
      - name: ğŸ“¦ Preparar artefatos
        run: |
          echo "ğŸ“¦ Criando pacote para deploy..."
          pip install -r requirements.txt
          echo "âœ… Artefatos preparados!"

      # PASSO 4: Simula deploy (substitua com seu processo real)
      - name: ğŸš€ Deploy para Stage
        run: |
          echo "ğŸš€ Iniciando deploy para ambiente de STAGE..."
          echo "ğŸ“ Ambiente: Stage"
          echo "ğŸ“¦ VersÃ£o: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo ""
          echo "âœ… Deploy realizado com sucesso!"
          echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: https://stage.exemplo.com"
        
      # PASSO 5: Notifica sucesso
      - name: âœ… Notificar conclusÃ£o
        if: success()
        run: |
          echo "============================================"
          echo "âœ… PIPELINE CONCLUÃDA COM SUCESSO!"
          echo "============================================"
          echo "ğŸ”’ SeguranÃ§a: Aprovado pelo CodeQL"
          echo "ğŸ§ª Testes: Todos passaram"
          echo "ğŸš€ Deploy: Realizado em Stage"
          echo "============================================"

      # PASSO 6: Notifica falha
      - name: âŒ Notificar falha
        if: failure()
        run: |
          echo "============================================"
          echo "âŒ PIPELINE FALHOU!"
          echo "============================================"
          echo "Verifique os logs acima para detalhes"
          echo "============================================"
